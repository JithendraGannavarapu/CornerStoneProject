# Lab 4 – Stack-Based Virtual Machine and Assembler

## Overview
This project implements a **stack-based virtual machine (VM)** and a **two-pass assembler**.  
The assembler converts human-readable assembly (`.asm`) into word-based bytecode (`.byc`), and the VM executes the generated bytecode using a strict fetch–decode–execute model.

---

## Key Features
- Word-based bytecode (32-bit opcodes and operands)
- Stack-based execution model
- Two-pass assembler with label support
- Arithmetic, control flow, and function calls
- Proper CALL / RET semantics with call stack
- Robust runtime error handling
- Execution statistics (instruction count, max stack depth)
- Automated test suite

---

## Instruction Set (Summary)
- **Stack:** `PUSH`, `POP`, `DUP`
- **Arithmetic:** `ADD`, `SUB`, `MUL`, `DIV`
- **Control Flow:** `CMP`, `JMP`, `JZ`, `JNZ`
- **Functions:** `CALL`, `RET`
- **Memory:** `LOAD`, `STORE`
- **Termination:** `HALT`

---

## Bytecode Format
- Each instruction occupies **one 32-bit word**
- Instructions with operands use an **additional 32-bit word**
- Program counter (PC) advances by **one word per fetch**

This design simplifies decoding and ensures predictable execution.

---

## Assembler Design
- **Pass 1:** Collects labels and computes word-based addresses
- **Pass 2:** Generates bytecode and resolves labels
- Ignores empty and comment-only lines to maintain correct alignment

---

## Virtual Machine Design
- Strict **fetch–decode–execute** cycle
- PC always points to a valid opcode at fetch time
- Separate operand stack and call stack
- Execution stops immediately on `HALT` or fatal error

---

## Error Handling
The VM detects and reports:
- Stack underflow
- Division by zero
- Invalid jump or call targets
- Program counter out-of-bounds
- Unknown opcodes (with PC value)

---

## Execution Statistics
After execution, the VM reports:
- **Instructions executed**
- **Maximum stack depth**

These metrics help analyze program behavior and control-flow complexity.

---

## Build Instructions

### Compile Assembler and Virtual Machine
```bash
g++ -std=c++17 Assembler.cpp -o assemble
g++ -std=c++17 VirtualMachine.cpp vm_main.cpp -o vm

---

### Usage
Assemble

./assemble program.asm

Execute
./vm program.byc

---

### Testing
Generate Test Programs

./run.sh

Run All Tests
./run_alltests.sh


The test suite covers arithmetic, stack operations, loops, nested loops, function calls, and error cases.